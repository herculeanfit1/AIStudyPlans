name: Send Feedback Campaign Emails

on:
  schedule:
    # Run at 9:00 AM UTC every day (adjust as needed)
    - cron: '0 9 * * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  send-campaign-emails:
    name: Send Feedback Campaign Emails
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Send Feedback Campaign Emails
        run: |
          echo "Calling feedback campaign API endpoint..."
          
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.FEEDBACK_CAMPAIGN_API_KEY }}" \
            ${{ secrets.NEXT_PUBLIC_APP_URL }}/api/feedback-campaign)
          
          if [ "$RESPONSE" != "200" ]; then
            echo "Error calling feedback campaign API. Status code: $RESPONSE"
            cat response.txt
            exit 1
          fi
          
          # Log results (with some redaction for privacy)
          RESULTS=$(cat response.txt | sed 's/"email":"[^"]*"/"email":"REDACTED"/g')
          echo "API Response: $RESULTS"
          
          # Check if we processed any users
          PROCESSED=$(echo $RESULTS | grep -o '"processed":[0-9]*' | cut -d':' -f2)
          echo "Processed $PROCESSED users for feedback campaign"
      
      - name: Report Status
        if: always()
        run: |
          if [ ${{ job.status }} == "success" ]; then
            echo "✅ Feedback campaign emails sent successfully."
          else
            echo "❌ Failed to send feedback campaign emails."
          fi 
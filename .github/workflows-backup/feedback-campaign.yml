name: Send Feedback Campaign Emails

on:
  schedule:
    # Run three times per week on optimal days
    # Tuesday at 10:00 AM UTC (mid-morning sweet spot)
    - cron: '0 10 * * 2'
    # Thursday at 10:00 AM UTC (highest performing day)
    - cron: '0 10 * * 4'
    # Early Monday at 5:00 AM UTC (early morning peak, start of week)
    - cron: '0 5 * * 1'
  
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  send-campaign-emails:
    name: Send Feedback Campaign Emails
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Send Feedback Campaign Emails
        run: |
          echo "Calling feedback campaign API endpoint..."
          
          # Add scientific-backed send time context
          WEEKDAY=$(date +%u)
          HOUR=$(date +%H)
          echo "Current day: $(date +%A) (day $WEEKDAY of week), time: $HOUR:$(date +%M) UTC"
          echo "Sending during optimal engagement window (research shows 74-91% open rates for well-timed emails)"
          
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.FEEDBACK_CAMPAIGN_API_KEY }}" \
            ${{ secrets.NEXT_PUBLIC_APP_URL }}/api/feedback-campaign)
          
          if [ "$RESPONSE" != "200" ]; then
            echo "Error calling feedback campaign API. Status code: $RESPONSE"
            cat response.txt
            exit 1
          fi
          
          # Log results (with some redaction for privacy)
          RESULTS=$(cat response.txt | sed 's/"email":"[^"]*"/"email":"REDACTED"/g')
          echo "API Response: $RESULTS"
          
          # Check if we processed any users
          PROCESSED=$(echo $RESULTS | grep -o '"processed":[0-9]*' | cut -d':' -f2)
          echo "Processed $PROCESSED users for feedback campaign"
          
          # Calculate time to next run (approximate)
          if [ "$WEEKDAY" -eq "1" ]; then
            echo "Next run: Tuesday at 10:00 AM UTC (approximately 29 hours from now)"
          elif [ "$WEEKDAY" -eq "2" ]; then
            echo "Next run: Thursday at 10:00 AM UTC (approximately 48 hours from now)"
          else
            echo "Next run: Monday at 5:00 AM UTC"
          fi
      
      - name: Report Status
        if: always()
        run: |
          if [ ${{ job.status }} == "success" ]; then
            echo "✅ Feedback campaign emails sent successfully."
          else
            echo "❌ Failed to send feedback campaign emails."
          fi 